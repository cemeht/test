<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>onSelectCar example</title>
    <style>

        div.tableHeader {
            font-size: 120%; /* Размер шрифта в процентах */
            font-family: serif; /* Шрифт с засечками */
            color: #656565;
        }

        div.tableEntry {
            padding-bottom: 45px;
        }
    </style>
</head>
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>
<script src="external-settings.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css" />
<div id="grid"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];
    var infoDiv = document.createTextNode("");

    var columns = [
        {field: "CalculatedDistance", title: "Рассчетное расстояние"},
        {field: "TotalDistance", title: "Фактическое расстояние"}
    ];

    let get = function (url, data, callback) {
        $.ajax
        ({
            url: url,
            type: 'get',
            data: data,
            success: function (data) {
                callback(data);
            }
        });
    }

    //конструктор span для kendo
    function createSpan(fieldName) {
        var spanElement = document.createElement('span');
        spanElement.setAttribute("data-format", "standart");
        spanElement.setAttribute("data-bind", `text: ${fieldName}`);
        return spanElement;
    }

    //создаем, заполняем таблицу и добавляем ее в родительский div
    function appendTableToDiv(divSource, dataSource) {
        let tableName = `tab${divCounter}`;
        var newDiv = document.createElement('div');
        newDiv.setAttribute("id", tableName);
        newDiv.appendChild(document.createElement("br"));
        divSource.appendChild(newDiv);
        document.body.appendChild(divSource);
        updateTable(tableName, dataSource);
        divCounter++;
    }

    function updateTable(tableName, dataSource) {
        if (dataSource.length > 0)
            $(`#${tableName}`).kendoGrid({
                columns: columns,
                dataSource: {
                    data: dataSource
                }
            });
    }

    function removeTables(instanceName, maxCounter = 1) {
        for (var counter = 0; counter < maxCounter; counter++) {
            document.getElementById(`${instanceName}${counter}`).remove();
        }
    }

    function dateToApiFormat(date) {
        var twoDigitMonth = ((date.getMonth() + 1) >= 10) ? (date.getMonth() + 1) : '0' + (date.getMonth() + 1);
        var twoDigitDate = ((date.getDate()) >= 10) ? (date.getDate()) : '0' + (date.getDate());
        var twoDigitHours = ((date.getHours()) >= 10) ? (date.getHours()) : '0' + (date.getHours());
        var twoDigitMinutes = ((date.getMinutes()) >= 10) ? (date.getMinutes()) : '0' + (date.getMinutes());
        return `${date.getFullYear()}${twoDigitMonth}${twoDigitDate}-${twoDigitHours}${twoDigitMinutes}`;
    }

    function printInfo() {

    }

    function joinPoints(points) {
        if (points.length > 0) {
            var result = `${points[0].Lat},${points[0].Lng}`;
            for (var counter = 1; counter < points.length; counter++) {
                result += `&point=${points[counter].Lat},${points[counter].Lng}`;
            }
            return result;
        }
        return null;
    }

    window.parent.AppDispatcher.add('routeComparerListener', {
        onTripSelected: function (car, tripIndex, sd, ed) {
            infoDiv.textContent = "";
            document.body.appendChild(infoDiv);
            //removeTables(divCounter);
            divCounter = 0;

            get(`${parm.Urls.Service}/GetTrips`, {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                IDs: car.ID,
                sd: dateToApiFormat(sd),
                ed: dateToApiFormat(ed),
                tripSplitterIndex: 0
            }, function (trips) {
                var currentTrip = Object.entries(trips[car.ID].Trips)[tripIndex];
                var points = [
                    {
                        Lat: currentTrip[1].PointStart.Lat,
                        Lng: currentTrip[1].PointStart.Lng
                    },
                    {
                        Lat: currentTrip[1].PointEnd.Lat,
                        Lng: currentTrip[1].PointEnd.Lng
                    }
                ];
                var url = `https://graphhopper.com/api/1/route?point=${currentTrip[1].PointStart.Lat},${currentTrip[1].PointStart.Lng}&point=${currentTrip[1].PointEnd.Lat},${currentTrip[1].PointEnd.Lng}&vehicle=car&debug=true&key=a8d5882e-f57d-4822-861c-b0b846d75269&type=json&points_encoded=false&locale=ru&instructions=false`;
                //https://graphhopper.com/api/1/route?point=55.1871802,61.3307691&point=55.1806810,61.3686633&vehicle=car&debug=true&key=a8d5882e-f57d-4822-861c-b0b846d75269&type=json&points_encoded=false&locale=ru&instructions=false
//                get(`${parm.Settings['graphhopper_url']}/route`, {
                get(`${url}`, null
                , function (route) {
                    updateTable('grid',[
                        {
                            CalculatedDistance: route.paths[0].distance / 1000,
                            TotalDistance: currentTrip[1].Total.TotalDistance
                        }
                        ]
                    );
                });
            });
        }
    });

</script>
</body>
</html>