<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Оптимальный маршрут</title>
</head>
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>
<script src="external-settings.js"></script>
<script src="web.js"></script>
<script src="graphhopper.js"></script>
<script src="autoGraphApi.js"></script>
<script src="htmlassistant.js"></script>
<script src="mapdrawer.js"></script>
<script src="apiassistant.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"
/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
<div id="selectRouteService"></div>
<div id="grid"></div>
<div id="map" style="width: 100%; height: 600px"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];

    var currentTrack = Object();
    var apiList = initApiLists();
    mapId = 'map';
    var mapObjects = initMap(mapId);

    $("#selectRouteService").kendoDropDownList({
        dataSource: apiList.apiNamesList
    });
    var dropdownlist = $("#selectRouteService").data("kendoDropDownList");
    dropdownlist.bind("change", updateCalculatedRoute);
    dropdownlist.select(1);

    function updateRouteFromApiHandler(startPoint, endPoint) {
        apiList.apiHandlersList[dropdownlist.selectedIndex].getRoute(startPoint, endPoint).then(function (result) {
            feelCalculatedRouteResult(result);
        });
    }

    function feelCalculatedRouteResult(route) {
        updateTable('grid', [
                {
                    CalculatedDistance: route.totalDistance + ' км',
                    TotalDistance: currentTrack.currentTrip.Total.TotalDistance + ' км'
                }
            ]
        );
        drawTrack(route.points, 'green', 'Рассчетный трек', mapObjects.calculatedRouteLayer);
    }

    function updateActualRoute() {
        return new Promise((resolve, reject) => {
            get(parm.Urls.Service + '/GetTrips', {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                IDs: currentTrack.car.ID,
                sd: dateToUtcApiFormat(currentTrack.sd),
                ed: dateToUtcApiFormat(currentTrack.ed),
                tripSplitterIndex: 0
            }, function (trips) {
                currentTrack.currentTrip = Object.entries(trips[currentTrack.car.ID].Trips)[0][1];

                setDeviceMarker(currentTrack.currentTrip.PointEnd, currentTrack.car.Name);
                get(parm.Urls.Service + '/GetTrack', {
                    session: parm.Token,
                    schemaID: parm.Organization.UID,
                    IDs: currentTrack.car.ID,
                    sd: dateToUtcApiFormat(currentTrack.sd),
                    ed: dateToUtcApiFormat(currentTrack.ed),
                    tripSplitterIndex: 0
                }, function (track) {
                    currentTrack.currentTrip.Total.TotalDistance = round(currentTrack.currentTrip.Total.TotalDistance);
                    let points = getPointsFromTrack(currentTrack.car.ID, track);
                    drawTrack(points, 'red', 'Фактический трек');
                    resolve();
                });
            });
        });
    }

    function updateCalculatedRoute() {
        mapObjects.calculatedRouteLayer.clearLayers();
        if (!!currentTrack)
            updateRouteFromApiHandler(currentTrack.currentTrip.PointStart, currentTrack.currentTrip.PointEnd, mapObjects.calculatedRouteLayer);
    }

    window.parent.AppDispatcher.add('routeComparerListener', {
        onTripSelected: function (inCar, inTripIndex, inSd, inEd) {
            clearMapLayers();
            currentTrack.sd = inSd;
            currentTrack.ed = inEd;
            currentTrack.car = inCar;
            updateActualRoute().then(function () {
                updateCalculatedRoute();
            });
        },

        onSelectCar: function (car) {
            currentTrack = Object();
            clearMapLayers();
        },
    });

</script>
</body>
</html>