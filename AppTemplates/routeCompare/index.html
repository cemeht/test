<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>onSelectCar example</title>
    <style>

        div.tableHeader {
            font-size: 120%; /* Размер шрифта в процентах */
            font-family: serif; /* Шрифт с засечками */
            color: #656565;
        }

        div.tableEntry {
            padding-bottom: 45px;
        }
    </style>
</head>
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>
<script src="external-settings.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"
/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
<div id="grid"></div>
<div id="map" style="width: 100%; height: 600px"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];
    var infoDiv = document.createTextNode("");

    var columns = [
        {field: "CalculatedDistance", title: "Рассчетное расстояние Graphhopper"},
        {field: "TotalDistance", title: "Фактическое расстояние"}
    ];

    var mymap = L.map('map').setView([55.172589, 61.406295], 10);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy;OpenStreetMap contributors, ' +
            'Imagery ©Mapbox',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
    }).addTo(mymap);
    var marker;

    let get = function (url, data, callback) {
        $.ajax
        ({
            url: url,
            type: 'get',
            data: data,
            traditional: true,
            success: function (data) {
                callback(data);
            }
        });
    }

    function updateTable(tableName, dataSource) {
        if (dataSource.length > 0)
            $(`#${tableName}`).kendoGrid({
                columns: columns,
                dataSource: {
                    data: dataSource
                }
            });
    }

    function removeTables(instanceName, maxCounter = 1) {
        for (var counter = 0; counter < maxCounter; counter++) {
            document.getElementById(`${instanceName}${counter}`).remove();
        }
    }

    function dateToApiFormat(date) {
        var twoDigitMonth = ((date.getMonth() + 1) >= 10) ? (date.getMonth() + 1) : '0' + (date.getMonth() + 1);
        var twoDigitDate = ((date.getDate()) >= 10) ? (date.getDate()) : '0' + (date.getDate());
        var twoDigitHours = ((date.getHours()) >= 10) ? (date.getHours()) : '0' + (date.getHours());
        var twoDigitMinutes = ((date.getMinutes()) >= 10) ? (date.getMinutes()) : '0' + (date.getMinutes());
        return `${date.getFullYear()}${twoDigitMonth}${twoDigitDate}-${twoDigitHours}${twoDigitMinutes}`;
    }

    function pointToParameterFormat(point) {
        return `${point.Lat},${point.Lng}`;
    }

    function drawTrack(latlngs, color = 'red', popup) {
        var polyline = L.polyline(latlngs, {color: color}).addTo(mymap);
        polyline.bindPopup(popup);
    }

    window.parent.AppDispatcher.add('routeComparerListener', {
        onTripSelected: function (car, tripIndex, sd, ed) {
            infoDiv.textContent = "";
            document.body.appendChild(infoDiv);

            get(`${parm.Urls.Service}/GetTrips`, {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                IDs: car.ID,
                sd: dateToApiFormat(sd),
                ed: dateToApiFormat(ed),
                tripSplitterIndex: 0
            }, function (trips) {
                var currentTrip = Object.entries(trips[car.ID].Trips)[tripIndex];
                mymap.setView([currentTrip[1].PointEnd.Lat, currentTrip[1].PointEnd.Lng], 9);
                marker = L.marker([currentTrip[1].PointEnd.Lat, currentTrip[1].PointEnd.Lng]).addTo(mymap);
                marker.bindPopup(`${car.Name}`).openPopup();

                get(`${parm.Urls.Service}/GetTrack`, {
                    session: parm.Token,
                    schemaID: parm.Organization.UID,
                    IDs: car.ID,
                    sd: dateToApiFormat(sd),
                    ed: dateToApiFormat(ed),
                    tripSplitterIndex: 0
                }, function (track) {
                    var latlngs = [];
                    for (var counter = 0; counter < track[car.ID][0].DT.length; counter++) {
                        latlngs.push([track[car.ID][0].Lat[counter], track[car.ID][0].Lng[counter]]);
                    }
                    drawTrack(latlngs, "red", "Фактический трек");

                    get(`${parm.Settings['graphhopper_url']}/route`, {
                        key: parm.Settings['graphhopper_api_key'],
                        vehicle: 'car',
                        type: 'json',
                        point: [pointToParameterFormat(currentTrip[1].PointStart), pointToParameterFormat(currentTrip[1].PointEnd)],
                        points_encoded: 'false',
                        locale: 'ru',
                        instructions: 'false'
                    }, function (route) {
                        updateTable('grid', [
                                {
                                    CalculatedDistance: route.paths[0].distance / 1000,
                                    TotalDistance: currentTrip[1].Total.TotalDistance
                                }
                            ]
                        );
                        var latlngs_calc = [];
                        route.paths[0].points.coordinates.forEach(function (point) {
                                latlngs_calc.push([point[1], point[0]]);
                            }
                        );
                        drawTrack(latlngs_calc, "green", "Рассчетный трек");
                    });
                });
            });
        }
    });

</script>
</body>
</html>