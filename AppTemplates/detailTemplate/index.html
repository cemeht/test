<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Многоуровневые таблицы</title>
</head>
</head>
<body>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"
/>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<script src="external-settings.js"></script>
<script src="web.js"></script>
<script src="apiassistant.js"></script>

<div id="grid"></div>
<script id="detail-template" type="text/x-kendo-template">
    <div>
        <div class="details"></div>
    </div>
</script>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];

    var carId = '';

    var stagesList = [
        {stageName: 'Motion'},
        {stageName: 'Geofence'},
        {stageName: 'Daylight'}
    ];

    function getStages(carId, stageName, sd, ed) {
        return new Promise((resolve, reject) => {
            get(parm.Urls.Service + '/GetStage', {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                IDs: carId,
                sd: dateToApiFormat(sd),
                ed: dateToApiFormat(ed),
                tripParams: '*',
                tripTotalParams: '*',
                stageName: stageName
            }, function (stages) {
                if (!!stages[carId])
                    resolve(stages[carId].Items);
            });
        });
    }

    function drawKendoTable()
    {
        $("#grid").kendoGrid({
            columns: [
                {field: "stageName", title: "Стадия"}
            ],
            dataSource: stagesList,
            detailTemplate: kendo.template($("#detail-template").html()),
            detailInit: detailInit
        });
    }

    function detailInit(e) {
        var detailRow = e.detailRow;
        var model = e.data;
        kendo.bind(detailRow, model);
        model.bind('change', function (e) {
            var tr = $('tr[data-uid=' + model.id + ']');
            $('#grid').data().kendoGrid.expandRow(tr);
        })
        detailRow.find(".tabstrip").kendoTabStrip({
            animation: {
                open: {effects: "fadeIn"}
            }
        });
        var sd = setStartOfTheDay(new Date());
        var ed = setEndOfTheDay(new Date());
        getStages(carId, model.stageName, sd, ed).then(function (stages) {
            detailRow.find(".details").kendoGrid({
                dataSource: stages,
                scrollable: false,
                sortable: true,
                pageable: true,
                columns: [
                    {field: 'Caption', width: 170, title: "Вид движения"},
                    {field: 'SD', width: 170, title: "Время начала"},
                    {field: 'ED', width: 170, title: "Время окончания"},
                    {field: 'StartPoint', width: 170, title: "Стартовая точка"},
                    {field: 'EndPoint', width: 170, title: "Конечная точка"},
                ]
            });
        });
    }

    window.parent.AppDispatcher.add('carSelectAppListener', {
        onSelectCar: function (car) {
            console.info('onSelectCar', {car: car});
            carId = car.ID;
            drawKendoTable();
        },
    });
</script>
</body>
</html>