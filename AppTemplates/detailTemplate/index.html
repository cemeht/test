<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Многоуровневые таблицы</title>
</head>
</head>
<body>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"
/>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<script src="external-settings.js"></script>
<script src="web.js"></script>
<script src="apiassistant.js"></script>

<div id="grid"></div>
<script id="detail-template" type="text/x-kendo-template">
    <div>
        <div class="details"></div>
    </div>
</script>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];

    var objectParm = Object();

    var stagesList = [
        {stageName: 'Motion'},
        {stageName: 'GeoFence'},
        {stageName: 'Daylight'},
        {stageName: 'Power'},
        {stageName: 'Overspeed'}
    ];

    function getStages(carId, stageName, sd, ed) {
        return new Promise((resolve, reject) => {
            get(parm.Urls.Service + '/GetStage', {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                IDs: carId,
                sd: dateToUtcApiFormat(sd),
                ed: dateToUtcApiFormat(ed),
                tripParams: '*',
                tripTotalParams: '*',
                stageName: stageName
            }, function (stages) {
                if (!!stages[carId])
                    resolve(stages[carId].Items);
            });
        });
    }

    function drawKendoTable() {
        document.getElementById("grid").innerHTML = "";
        $("#grid").kendoGrid({
            columns: [
                {field: "stageName", title: "Стадия"}
            ],
            dataSource: stagesList,
            detailTemplate: kendo.template($("#detail-template").html()),
            detailInit: detailInit
        });
    }

    function detailInit(e) {
        let detailRow = e.detailRow;
        let model = e.data;
        kendo.bind(detailRow, model);
        model.bind('change', function (e) {
            var tr = $('tr[data-uid=' + model.uid + ']');
            $('#grid').data().kendoGrid.expandRow(tr);
        });
        getStages(objectParm.carId, model.stageName, objectParm.sd, objectParm.ed)
            .then(function (stages) {
                detailRow.find(".tabstrip").kendoTabStrip({
                    animation: {
                        open: {effects: "fadeIn"}
                    }
                });
                let detailsRow = detailRow.find(".details");
                detailsRow.kendoGrid({
                    dataSource: stages,
                    scrollable: true,
                    sortable: true,
                    columns: [
                        {field: 'Caption', width: 170, title: "Вид движения"},
                        {field: 'SD', width: 170, title: "Время начала"},
                        {field: 'ED', width: 170, title: "Время окончания"},
                        {
                            field: 'StartPoint',
                            width: 170,
                            title: "Стартовая точка",
                            template: 'Широта: #: StartPoint.Lng# Долгота #: StartPoint.Lat#'
                        },
                        {
                            field: 'EndPoint',
                            width: 170,
                            title: "Конечная точка",
                            template: 'Широта: #: EndPoint.Lng# Долгота #: EndPoint.Lat#'
                        },
                    ]
                });
                var x = 5;
            });
    }

    window.parent.AppDispatcher.add('carSelectAppListener', {
        onTripSelected: function (car, tripIndex, sd, ed) {
            drawKendoTable();
            console.info('onTripSelected', {car: car, tripIndex: tripIndex, sd: sd, ed: ed});
            objectParm.carId = car.ID;
            objectParm.sd = sd;
            objectParm.ed = ed;
        },

        onSelectCar: function (car) {
            console.info('onCarSelected', {car: car});
            drawKendoTable();
        },
    });
</script>
</body>
</html>