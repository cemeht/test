<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Kendo UI Snippet</title>

    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"/>

    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
    <script src="web.js"></script>
    <script src="apiassistant.js"></script>
</head>
<body>
<div id="grid"></div>
<script id="detail-template" type="text/x-kendo-template">
    <div>
        <div class="details"></div>
    </div>
</script>

<script>
    var carId = '58c2b7e8-f760-45c4-8ea3-e4674bc0fec9';
    var stagesList = [
        {stageName: 'Motion'},
        {stageName: 'Geofence'},
        {stageName: 'Daylight'}
    ];

    $("#grid").kendoGrid({
        columns: [
            {field: "stageName", title: "Стадия"}
        ],
        dataSource: stagesList,
        detailTemplate: kendo.template($("#detail-template").html()),
        detailInit: detailInit
    });

    function getStages(carId, stageName, sd, ed) {
        return new Promise((resolve, reject) => {
            get('http://localhost/ServiceJSON/GetStage', {
                session: "6CFF378EA4B23FCF65B6EAB96050930EA12CF9E1F51B8CC72D1629CE548DACA913F5A60A42EC16766DC587D5150C790B0691022376F79DF91391DF53D253BD86",
                schemaID: "b4b68be6-a124-4ca3-ab02-589e7c2ef102",
                IDs: carId,
                sd: dateToApiFormat(sd),
                ed: dateToApiFormat(ed),
                tripParams: '*',
                tripTotalParams: '*',
                stageName: stageName
            }, function (stages) {
                if (!!stages[carId])
                    resolve(stages[carId].Items);
            });
        });
    }

    function detailInit(e) {
        var detailRow = e.detailRow;
        var model = e.data;
        kendo.bind(detailRow, model);
        model.bind('change', function (e) {
            var tr = $('tr[data-uid=' + model.id + ']');
            $('#grid').data().kendoGrid.expandRow(tr);
        })
        detailRow.find(".tabstrip").kendoTabStrip({
            animation: {
                open: {effects: "fadeIn"}
            }
        });
        var sd = new Date();
        sd.setHours(0);
        sd.setMinutes(0);
        sd.setSeconds(0);
        var ed = new Date();
        ed.setHours(23);
        ed.setMinutes(59);
        ed.setSeconds(59);
        getStages(carId, model.stageName, sd, ed).then(function (stages) {
                detailRow.find(".details").kendoGrid({
                    dataSource: stages,
                    scrollable: false,
                    sortable: true,
                    pageable: true,
                    columns: [
                        {field: 'Caption', width: 270, title: "Вид движения"},
                        {field: 'SD', width: 270, title: "Время начала"},
                        {field: 'ED', width: 270, title: "Время окончания"},
                        {field: 'StartPoint', width: 270, title: "Стартовая точка"},
                        {field: 'EndPoint', width: 270, title: "Конечная точка"},
                    ]
                });
            }
        );

    }
</script>
</body>
</html>