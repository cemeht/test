<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>onSelectCar example</title>
</head>
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>
<script src="external-settings.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css" />
<div id="grid"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];
    var tablesDiv = document.createElement('div');
    tablesDiv.setAttribute("id", `tablesDiv`);

    var columns = [
        {field: "fuelType", title: "Тип топлива"},
        {field: "price", title: "Стоимость"}
    ];

    var tolerance = 0.1561 //радиус 10км
    var divCounter = 0;

    let get = function (url, data, callback) {
        $.ajax
        ({
            url: url,
            type: 'get',
            data: data,
            success: function (data) {
                callback(data);
            }
        });
    }

    function getGasStations(Position) {
        get(`/ESGeo/Load/${parm.Organization.ID}`, {
            service: "GasStations",
            lat1: Position.Lat - tolerance,
            lng1: Position.Lng - tolerance,
            lat2: Position.Lat + tolerance,
            lng2: Position.Lng + tolerance,
        }, function (gasStations) {
            gasStations.forEach(function (gasStation) {
                printGasStationInfo((gasStation));
            });
        });
    }

    function propName(prop, value) {
        for (var i in prop) {
            if (prop[i] == value) {
                return i;
            }
        }
        return false;
    }

    function checkIsFuel(propertyName) {
        if (propertyName == 'Address' || propertyName == 'Type')
            return false;
        return true;
    }

    function printGasStationInfo(gasStation) {

        var dataSource = [];
        var props = Object.entries(gasStation.Props);
        props.forEach(function (property) {
            if (checkIsFuel(property[0]))
                dataSource.push(
                    {
                        fuelType: property[0],
                        price: property[1]
                    }
                );
        });
        if (dataSource.length > 0) {
            var headerDiv = document.createElement('div');
            var headerName = "Наименование: " + gasStation.ID;
            var coordsName = "Координаты: lat " + gasStation.Lat + " lng " + gasStation.Lng;
            headerDiv.appendChild(document.createTextNode(headerName));
            headerDiv.appendChild(document.createElement("br"));
            headerDiv.appendChild(document.createTextNode(coordsName));
            headerDiv.appendChild(document.createElement("br"));
            tablesDiv.appendChild(headerDiv);

            createTable(dataSource);
        } else {
            tablesDiv.appendChild(document.createTextNode("Нет заправок поблизости!"));
            document.body.appendChild(tablesDiv);
        }
    }

    function createTable(dataSource) {

        var newDiv = document.createElement('div');
        newDiv.setAttribute("id", `tab${divCounter}`);
        newDiv.appendChild(document.createElement("br"));
        tablesDiv.appendChild(newDiv);
        document.body.appendChild(tablesDiv);

        if (dataSource.length > 0)
            $(`#tab${divCounter}`).kendoGrid({
                columns: columns,
                dataSource: {
                    data: dataSource
                }
            });
        divCounter++;
    }

    window.parent.AppDispatcher.add('CarListener', {
        onSelectCar: function (car) {
            tablesDiv.innerHTML = '';
            //получаем список всех онлайн устройств, чтобы выдернуть последнюю координату выбранного устройства
            get(`${parm.Urls.Service}/GetOnlineInfoAll`, {
                session: parm.Token,
                schemaID: parm.Organization.UID,
                finalParams: '*'
            }, function (onlineDevices) {
                Object.entries(onlineDevices).forEach(function (device) {
                    if (device[0] == car.ID)
                        getGasStations(device[1].LastPosition);
                });
            });
        }
    });

</script>
</body>
</html>