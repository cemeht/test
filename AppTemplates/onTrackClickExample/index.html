<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>onSelectCar example</title>
</head>
    <script src="external-settings.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
    <script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css" />
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>

<div id="grid"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];
    var rapidApiToken = "a99ed6ea3cmshe42862c83561be7p114f6djsn5291a66ef649";

    var columns = [
        {field: "Vehicle", label: "Автомобиль"},
        {field: "Serial", label: "Серийный номер устройства"},
        {field: "TotalMH", label: "Моточасы"},
        {field: "TotalKM", label: "Пробег"}
    ];

    let get = function (url, data, callback) {
        $.ajax
        ({
            url: url,
            type: 'get',
            data: data,
            success: function (data) {
                callback(data);
            }
        });
    }

    function updateTable(dataSource) {
        if (dataSource.length > 0)
            $("#grid").kendoGrid({
                columns: columns,
                dataSource: {
                    data: dataSource
                }
            });
    }

    function formatDate(date) {
        var twoDigitMonth = ((date.getMonth() + 1) >= 10) ? (date.getMonth() + 1) : '0' + (date.getMonth() + 1);
        var twoDigitDate = ((date.getDate()) >= 10) ? (date.getDate()) : '0' + (date.getDate());
        return `${date.getFullYear()}${twoDigitMonth}${twoDigitDate}-${date.getHours}${date.getMinutes()}`;
    }

    function formatDateUtcForDarkSkyApi(date) {
        var twoDigitMonth = ((date.getUTCMonth() + 1) >= 10) ? (date.getUTCMonth() + 1) : '0' + (date.getUTCMonth() + 1);
        var twoDigitDate = ((date.getUTCDate()) >= 10) ? (date.getUTCDate()) : '0' + (date.getUTCDate());
        var twoDigitHours = ((date.getUTCHours()) >= 10) ? (date.getUTCHours()) : '0' + (date.getUTCHours());
        var twoDigitMinutes = ((date.getUTCMinutes()) >= 10) ? (date.getUTCMinutes()) : '0' + (date.getUTCMinutes());
        var twoDigitSeconds = ((date.getUTCSeconds()) >= 10) ? (date.getUTCSeconds()) : '0' + (date.getUTCSeconds());
        return `${date.getUTCFullYear()}-${twoDigitMonth}-${twoDigitDate}T${twoDigitHours}:${twoDigitMinutes}:${twoDigitSeconds}`;
    }

    window.parent.AppDispatcher.add('CarListener', {
        onTrackClick: function (car, point, angle, pntIndex, timePos, dist, info) {
            console.info('onTrackClick', {car: car, point: point, angle: angle, pntIndex: pntIndex, timePos: timePos, dist: dist, info: info});
            //инициализируем пустую таблицу
            updateTable([]);

            const settings = {
                "async": true,
                "crossDomain": true,
                "url": `https://dark-sky.p.rapidapi.com/${point.lat},${point.lng},${formatDateUtcForDarkSkyApi(info.dt)}Z?lang=ru`,
                "method": "GET",
                "headers": {
                    "x-rapidapi-key": rapidApiToken,
                    "x-rapidapi-host": "dark-sky.p.rapidapi.com"
                }
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
            });
        }
    });
</script>
</body>
</html>