!function(e){var t={};function s(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(r,a,function(t){return e[t]}.bind(null,a));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){},function(e,t,s){"use strict";s.r(t);s(0);class r{constructor(e,t,s){this.nameFolder="(folder)",this.containerTree=e,this.templateItem=document.getElementById("objects__item-template"),this.templateTree=document.getElementById("objects__tree-sub-template"),this.urlImage=t,this.callback=s}buildTree(e,t,s){void 0!==t[e]&&t[e].forEach(e=>{s.appendChild(this.templateItem.content.cloneNode(!0));const r=s.childNodes[s.childElementCount-1];this.setElementData(r,e),void 0!==t[e.ID]&&(r.appendChild(this.templateTree.content.cloneNode(!0)),this.buildTree(e.ID,t,r.childNodes[r.childElementCount]))})}setElementData(e,t){const s=e.querySelector(".objects__checkbox"),r=e.querySelector(".objects__label"),a=e.querySelector(".objects__item-image img"),i=e.querySelector(".objects__item-name"),o="checkbox-object-"+t.ID;s.setAttribute("id",o),s.setAttribute("data-id",t.ID),s.setAttribute("data-group",t.IsGroup.toString()),r.setAttribute("for",o);const n=(e,t)=>{const s=t.parentElement,r=s.querySelectorAll(".objects__item > .objects__checkbox");let a=!1;for(let t=0;t<r.length;t++)if(e!==r[t].checked){a=!0;break}const i=s.parentElement;if(i.classList.contains("objects__item")){const t=i.querySelector(".objects__checkbox");t.indeterminate=a,t.checked=e,n(e,i)}};s.addEventListener("click",()=>{const t=e.getElementsByClassName(s.className);[].forEach.call(t,e=>{e.indeterminate=!1,e.checked=s.checked}),n(s.checked,e),this.callback()}),a.src=this.urlImage+"/"+(t.IsGroup?this.nameFolder:t.ImageColored),i.innerHTML=t.Name}setData(e){const t={},s={null:[]},r=e.Groups.map(e=>(e.IsGroup=!0,e)),a=e.Items.map(e=>(e.IsGroup=!1,e));return r.concat(a).forEach(e=>{void 0===s[e.ParentID]&&(s[e.ParentID]=[]),s[e.ParentID].push(e),t[e.ID]=e}),this.buildTree("null",s,this.containerTree),t}getChecked(){const e=this.containerTree.querySelectorAll('.objects__checkbox[data-group="false"]:checked'),t=[];return[].forEach.call(e,e=>t.push(e.getAttribute("data-id"))),t}}class a{constructor(e){this.sd=new Date,this.ed=new Date,this.callback=e,this.fieldset=document.querySelector(".period__fieldset");const t=document.querySelector(".period__control--down"),s=document.querySelector(".period__control--up"),r=document.querySelector(".period__date--start"),a=document.querySelector(".period__date--end");try{const e=localStorage.getItem("period");if(e){const t=JSON.parse(e);this.sd=new Date(t.sd),this.ed=new Date(t.ed)}}catch(e){}this.sd.setHours(0,0,0,0),this.ed.setHours(23,59,59,999),r.setAttribute("max",this.dateToValue(this.ed)),a.setAttribute("max",this.dateToValue(this.ed)),r.value=this.dateToValue(this.sd),a.value=this.dateToValue(this.ed),t.addEventListener("click",()=>this.onClickPeriodSlide(-1,r,a)),s.addEventListener("click",()=>this.onClickPeriodSlide(1,r,a)),r.addEventListener("change",()=>this.onChangePeriod(r,a)),a.addEventListener("change",()=>this.onChangePeriod(r,a))}onClickPeriodSlide(e,t,s){const r=new Date(t.value),a=new Date(s.value),i=new Date;r.setDate(r.getDate()+e),a.setDate(a.getDate()+e),e>0&&(r.getTime()>i.getTime()&&(r.setDate(i.getDate()),r.setHours(0,0,0,0)),a.getTime()>i.getTime()&&(a.setDate(i.getDate()),a.setHours(23,59,59,999))),t.value=this.dateToValue(r),s.value=this.dateToValue(a),this.sd=r,this.ed=a,this.savePeriod(r,a),this.callback(r,a)}onChangePeriod(e,t){const s=new Date(e.value),r=new Date(t.value);this.sd=s,this.ed=r,this.savePeriod(s,r),this.callback(s,r)}dateToValue(e){const t=e.getMonth()+1,s=e.getDate(),r=e.getHours(),a=e.getMinutes();return[e.getFullYear(),(t>9?"":"0")+t,(s>9?"":"0")+s].join("-")+("T"+(r>9?"":"0")+r+":"+(a>9?"":"0")+a)}savePeriod(e,t){localStorage.setItem("period",JSON.stringify({sd:e.toISOString(),ed:t.toISOString()}))}getDate(){return{sd:this.sd,ed:this.ed}}disable(){this.fieldset.setAttribute("disabled","true")}enable(){this.fieldset.removeAttribute("disabled")}}class i{constructor(e){this.parameters={DateTimeFirst:{caption:"Время начала",format:e=>-1!==e.indexOf("T")?this.formatDate(new Date(e)):e},DateTimeLast:{caption:"Время конца",format:e=>-1!==e.indexOf("T")?this.formatDate(new Date(e)):e},Area:{caption:"Поле",format:e=>this.formatObject(e,"geofences",this.urls.ImageGF)},TotalArea:{caption:"Площадь, га</sup>",format:e=>'<div class="text--right">'+e+"</div>"},FullOverArea:{caption:"Обработано, га",format:e=>'<div class="text--right">'+e+"</div>"},FirstImplement:{caption:"Инструмент",format:e=>this.formatObject(e,"implements",this.urls.ImageImplements)}},this.parametersVisible=["DateTimeFirst","DateTimeLast","Area","TotalArea","FullOverArea","FirstImplement"],this.objects={},this.urls=e,this.table=document.querySelector(".datatable"),this.templateRowCar=document.getElementById("datatable__row-car-template"),this.templateRowTrip=document.getElementById("datatable__row-trip-template")}formatDate(e){const t=e.getDate(),s=e.getMonth()+1,r=e.getHours(),a=e.getMinutes();return(t>9?t:"0"+t)+"."+(s>9?s:"0"+s)+"."+e.getFullYear()+" "+((r>9?r:"0"+r)+":"+(a>9?a:"0"+a))}formatObject(e,t,s){const r=document.getElementById("datatable__object-template").content.cloneNode(!0),a=r.querySelector(".datatable__object-image img"),i=r.querySelector(".datatable__object-name"),o=this.objects[t].Items.find(t=>t.ID===e),n=document.createElement("div");return o?(a.src=s+"/"+o.ImageColored,i.innerHTML=o.Name,n.appendChild(r),n.innerHTML):e}setData(e){const t=this.table.querySelector("thead tr"),s=this.table.querySelector("tbody");t.innerHTML="",s.innerHTML="",this.table.classList[0===Object.keys(e).length?"add":"remove"]("hidden"),this.parametersVisible.forEach(e=>{const s=document.createElement("th");s.innerHTML=this.parameters[e].caption,t.appendChild(s)});for(let t in e){const r=e[t],a=this.objects.devices.Items.find(e=>e.ID===r.ID),i=this.templateRowCar.content.cloneNode(!0);i.querySelector(".datatable__car").setAttribute("colspan",this.parametersVisible.length.toString()),i.querySelector(".datatable__car-image img").src=this.urls.ImageCar+"/"+a.ImageColored,i.querySelector(".datatable__car-name").innerHTML=r.Name,i.querySelector(".datatable__car-serial").innerHTML=r.Serial,s.appendChild(i),e[t].Trips.forEach(e=>{s.appendChild(this.templateRowTrip.content.cloneNode(!0));const t=s.children[s.childElementCount-1];this.parametersVisible.forEach(s=>{const r=document.createElement("td"),a=Object.keys(e.Total);for(let t=0;t<a.length;t++)if(a[t].replace(/\s/g,"")===s){r.innerHTML=this.parameters[s].format(e.Total[a[t]]);break}t.appendChild(r)})})}}}new class{constructor(e){this.serial=+e.Settings.serial,this.url=e.Urls.Service+"/",this.token=e.Token,this.schemaID=e.Organization.UID,this.devices=new r(document.querySelector(".objects--devices .objects__tree"),e.Urls.ImageCar,()=>this.refreshData()),this.geofences=new r(document.querySelector(".objects--geofences .objects__tree"),e.Urls.ImageGF,()=>this.refreshData()),this.period=new a(()=>this.refreshData()),this.datatable=new i(e.Urls);const t={devices:{},geofences:{},implements:{}};this.progress(!0),Promise.all([this.post("EnumDevices",{},e=>{e.Items=e.Items.filter(e=>e.IsAreaEnabled),e.Groups=e.Groups.filter(t=>e.Groups.find(e=>e.ParentID===t.ID)||e.Items.find(e=>e.ParentID===t.ID)),t.devices=e,this.devices.setData(e)}),this.post("EnumGeoFences",{},e=>{t.geofences=e,this.geofences.setData(e)}),this.post("EnumImplements",{},e=>{t.implements=e})]).then(()=>{this.datatable.objects=t,this.progress(!1)})}refreshData(){const e=this.period.getDate();this.progress(!0),this.post("GetTripsAreaTotal",{IDs:this.devices.getChecked().join(","),areaIDs:this.geofences.getChecked().join(","),SD:this.fmtDT(e.sd),ED:this.fmtDT(e.ed),tripSplitterIndex:0},e=>{this.datatable.setData(e),this.progress(!1)})}fmtDT(e){const t=e.getMonth()+1,s=e.getDate(),r=e.getHours(),a=e.getMinutes();return e.getFullYear()+(t>9?"":"0")+t+(s>9?"":"0")+s+"-"+(r>9?"":"0")+r+(a>9?"":"0")+a}post(e,t,s){const r=new FormData;for(let e in t)r.append(e,t[e]);return r.append("session",this.token),r.append("schemaID",this.schemaID),fetch(this.url+e,{method:"POST",body:r}).then(e=>e.json().then(s)).catch(e=>console.error(e))}progress(e){document.querySelector("body").classList[e?"add":"remove"]("loading")}}(window["external-settings"])}]);
//# sourceMappingURL=bundle.js.map