<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            width: 100%;
        }

        .controlWrapper {
            position: fixed;
            width: 300px;
            right: 20px;
            top: 20px;
            background-color: rgba(0, 0, 0, .7);
            border-radius: 10px;
            padding: 10px 0;
        }

        @media (max-width: 768px) {
            .controlWrapper {
                position: fixed;
                width: 100%;
                top: auto;
                right: auto;
                left: 0px;
                bottom: 0px;
                background-color: rgba(0, 0, 0, .7);
                border-radius: 0;
                padding: 10px 0;
            }
        }

        .container-fluid {
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
        }

        .semi-white {
            color: #f0f0f0;
        }

        .col-xs-12 {
            width: 100%;
        }

        .col-xs-1, .col-xs-10, .col-xs-11, .col-xs-12, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9 {
            float: left;
        }

        .overflow {
            height: 200px;
        }

        button, input, select, textarea {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        button, select {
            text-transform: none;
        }

        button, input, optgroup, select, textarea {
            margin: 0;
            font: inherit;
            color: inherit;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""
    />

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <script src='https://unpkg.com/leaflet.marker.slideto@0.2.0/Leaflet.Marker.SlideTo.js'></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    <script src="external-settings.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />
    <script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css"
    />
</head>
<body>
<div style="position: fixed; width: 100%; height: 100%;" id="map"></div>
<div class="controlWrapper" id="form">
    <div class="container-fluid">
        <div id="mainGroups">
        <span title class="k-widget k-dropdown" role="listbox" class="overflow" style="width: 270px">
            <input data-role="dropdownlist"
                   data-auto-bind="false"
                   data-value-primitive="true"
                   data-text-field="Name" data-value-field="ID"
                   data-bind="
                                        value:ID,
                                        source:Groups,
                                        events: {change: onChange}"/>
            </span>
            </span>
        </div>
        <div id="childGroups">
        <span title class="k-widget k-dropdown" role="listbox" style="width: 270px">
            <input data-role="dropdownlist"
                   data-auto-bind="false"
                   data-value-primitive="true"
                   data-text-field="Name" data-value-field="ID"
                   data-bind="
                                        value:ID,
                                        source:Groups,
                                        events: {change: onChange}"/>
            </span>
        </div>
        <div id="statistics">
            <div class="col-xs-12 semi-white">
                Всего машин
                <hr>
            </div>
            <div id="allTrucks" class="col-xs-3 semi-white">
            </div>
            <div class="col-xs-9" style="/*padding-left: 0;*/">
                <div class="col-xs-12" style="padding: 0; background-color: rgba(255,255,255,.3);">
                    <div id="totalProgress"
                         data-role="progressbar"
                         data-min="0"
                         data-bind="enabled: isEnabled,
                            value: totalCarsInGroup"
                         style="width: 270px; background-color: #ccc; height: 20px;"></div>
                </div>
            </div>
            <div class="col-xs-12 semi-white" style="margin-top: 10px;">
                Машин на линии
                <hr>
            </div>
            <div id="allTrucksOnline" class="col-xs-3 semi-white">
            </div>
            <div class="col-xs-9" style="/*padding-left: 0;*/">
                <div class="col-xs-12" style="padding: 0; background-color: rgba(255,255,255,.3);">
                    <div id="onlineProgress"
                         data-role="progressbar"
                         data-min="0"
                         data-bind="enabled: isEnabled,
                            value: carsInGroupOnline"
                         style="width: 270px; background-color: #ccc; height: 20px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/map.js"></script>
<script src="js/treehelper.js"></script>
<script>
    const parm = window['external-settings'];
    const imagesPath = parm.Urls.App + "Content/cars/default/AG.NET/";
    let mapObject = InitMap('map', parm.Settings['ClusterSize']);
    let bounds = [];

    let currentGroupId; // ID текущей выбранной группы
    let currentDevices = []; // устройства, отрисованные в данный момент
    let rootGroup; // текущая рут-группа

    let onlineDevices = []; // текущие устройства online
    let allDevices = []; // все устройства в организации

    let mainGroupsViewModel; //объекты для меню первого уровня
    let nestedGroupsViewModel; //объекты для меню второго уровня
    let statsViewModel;

    updateOrganization().then((devices) => {
        allDevices = devices;
        rootGroup = devices.Groups.find(a => a.ParentID == null);
        currentGroupId = rootGroup.ID;

        updateL1Dropdown();
        updateL2Dropdown();
        updateDevices().then((online) => {
            onlineDevices = online;
            drawSubgroupDevices(onlineDevices);
            mapObject.map.fitBounds(bounds);
            let timeout = parm.Settings['RefreshTime'];
            if (!!!timeout) timeout = 60;
            setUpdateTimer(timeout);
        });
        initStats();
    });

    function initStats() {
        let statsInfo = {
            totalCarsInGroup: 0,
            carsInGroupOnline: 0
        };
        statsViewModel = kendo.observable(statsInfo);
        kendo.bind($('#statistics'), statsViewModel);
        let pbTotal = $("#totalProgress").data("kendoProgressBar");
        let pbOnline = $("#onlineProgress").data("kendoProgressBar");
        pbTotal.options.max = allDevices.Items.length;
        pbOnline.options.max = allDevices.Items.length;
    }

    function updateL1Dropdown() {
        let rootGroups = [];

        rootGroups.push({
            Name: "Все объекты",
            ID: rootGroup.ID
        });

        let rootGroupsArray = getChildrenGroups(allDevices, rootGroup.ID);
        rootGroupsArray.forEach(function (group) {
            rootGroups.push(group);
        });

        mainGroupsViewModel = kendo.observable({
            ID: rootGroups[0].ID,
            Name: rootGroups[0].Name,
            Groups: rootGroups,
            onChange: onMainGroupChange
        });
        kendo.bind($("#mainGroups"), mainGroupsViewModel);
    }

    function updateL2Dropdown() {
        let childGroups = [];
        childGroups.push({
            ID: mainGroupsViewModel.get('ID'),
            Name: "Все машины"
        });
        if (mainGroupsViewModel.get('ID') != rootGroup.ID) {
            let childGroupsArray = getChildrenGroups(allDevices, mainGroupsViewModel.get('ID'));
            childGroupsArray.forEach(function (group) {
                childGroups.push(group);
            });
        }
        nestedGroupsViewModel = kendo.observable({
            ID: childGroups[0].ID,
            Name: childGroups[0].Name,
            Groups: childGroups,
            onChange: onGroupChange
        });
        kendo.bind($("#childGroups"), nestedGroupsViewModel);
    }

    function onMainGroupChange() {
        updateL2Dropdown();
        currentGroupId = mainGroupsViewModel.get("ID");
        drawSubgroupDevices(onlineDevices);
        if (bounds.length > 0)
            mapObject.map.fitBounds(bounds);
    }

    function onGroupChange() {
        currentGroupId = nestedGroupsViewModel.get("ID");
        drawSubgroupDevices(onlineDevices);
        if (bounds.length > 0)
            mapObject.map.fitBounds(bounds);
    }

    function drawSubgroupDevices(devices, groupID) {
        if (!!!groupID)
            groupID = currentGroupId;
        let children = getChildren(allDevices, groupID);
        let childrenToDraw = [];
        children.forEach(function (device) {
            let found = devices.find(a => a.Name == device.Name);
            if (!!found) {
                childrenToDraw.push(found);
            }
        });
        statsViewModel.set('carsInGroupOnline', childrenToDraw.length);
        statsViewModel.set('totalCarsInGroup', children.length);
        drawDevices(childrenToDraw);
    }

    function drawDevices(onlineDevices) {
        let removeDevices = [];
        let newDevices = [];
        let changedDevices = [];
        //собираем, какие устройства изменились, а какие - новые
        onlineDevices.forEach(function (device) {
            let found = currentDevices.find(a => a.Name == device.Name);
            if (!!found) {
                found.LastPosition = device.LastPosition;
                changedDevices.push(found);
            } else {
                newDevices.push({
                    Name: device.Name,
                    Marker: createMarker(device),
                    LastPosition: device.LastPosition
                });
            }
        });
        //собираем, какие устройства пропали из отрисовки
        currentDevices.forEach(function (device) {
            let found = onlineDevices.find(a => a.Name == device.Name);
            if (!!!found)
                removeDevices.push(device);
        });
        //удаляем устаревшие устройства
        removeDevices.forEach(function (device) {
            mapObject.devicesLayer.removeLayer(device.Marker);
            currentDevices.splice(currentDevices.indexOf(device), 1);
        });
        //добавляем маркеры на карту у новых устройств
        newDevices.forEach(function (device) {
            mapObject.devicesLayer.addLayer(device.Marker);
            currentDevices.push({Name: device.Name, Marker: device.Marker, LastPosition: device.LastPosition});
        });
        //сдвигаем маркер для обновившихся устройств
        changedDevices.forEach(function (device) {
            device.Marker.setLatLng([device.LastPosition.Lat, device.LastPosition.Lng],);
        });
        //добавляем координаты для позиционирования карты
        bounds = [];
        onlineDevices.forEach(item => {
            bounds.push([item.LastPosition.Lat, item.LastPosition.Lng]);
        });
    }

    function updateOrganization() {
        return new Promise(function (resolve) {
            //получаем список всех устройств в организации
            $.get({
                url: parm.Urls.Service + '/EnumDevices?session=' + parm.Token + "&schemaID=" + parm.Organization.UID,
                success: function (allDevices) {
                    resolve(allDevices);
                }
            });
        });
    }

    function updateDevices() {
        return new Promise(function (resolve) {
            $.get({
                url: parm.Urls.Service + '/GetOnlineInfoAll?session=' + parm.Token + "&schemaID=" + parm.Organization.UID,
                success: function (onlineInfoAll) {
                    let online = Object.entries(onlineInfoAll).filter(a => !!a && !!a[1] && !!a[1].LastPosition).map(item => {
                        return {
                            LastPosition: item[1].LastPosition,
                            Name: item[1].Name,
                            Course: item[1].Course,
                            State: item[1].State,
                            Speed: item[1].Speed,
                            DeviceInfo: allDevices.Items.filter(a => !!a).find(a => a.ID == item[0]),
                            ID: item[0]
                        }
                    });
                    resolve(online);
                }
            });
        });
    }

    function getStateName(state) {
        switch (state) {
            case 0:
                return "Остановка";
            case 0:
                return "Движение";
            case 0:
                return "Полет";
            default:
                return "Неизвестно";
        }
    }

    function setUpdateTimer(timeoutSeconds) {
        setInterval(() => {
                updateDevices().then((result) => {
                    onlineDevices = result;
                    drawSubgroupDevices(result, currentGroupId);
                });
            },
            timeoutSeconds * 1000);
    }
</script>
</body>
</html>